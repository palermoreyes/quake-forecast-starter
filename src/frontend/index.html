<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Quake Forecast AI | Pron√≥stico S√≠smico Per√∫</title>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y0D090QHZ0"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-Y0D090QHZ0');
    </script>

    <!-- Favicons -->
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <link rel="apple-touch-icon" href="../images/favicon.png">
    
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- SEO b√°sico -->
    <meta name="description" content="Visualizaci√≥n experimental de pron√≥sticos s√≠smicos para el Per√∫ usando modelos LSTM. Proyecto acad√©mico, no oficial.">
    <meta name="author" content="Palermo Reyes, Paulo Arce">
    <meta name="keywords" content="sismos, per√∫, predicci√≥n s√≠smica, LSTM, machine learning, IGP">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Quake Forecast AI - Pron√≥stico S√≠smico Per√∫">
    <meta property="og:description" content="Sistema experimental de IA para pron√≥stico s√≠smico en Per√∫ usando Deep Learning (LSTM). Proyecto acad√©mico UPN.">
    <meta property="og:image" content="images/favicon.png">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Quake Forecast AI">
    <meta name="twitter:description" content="Pron√≥stico s√≠smico experimental con IA para Per√∫">
    <meta name="twitter:image" content="images/favicon.png">

    <!-- Color del navegador m√≥vil -->
    <meta name="theme-color" content="#020617">

    <!-- CSS externos -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- CSS propio -->
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <!-- Modal de Bienvenida -->
    <div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content dark-modal">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="welcomeLabel">
                        ü§ñ Quake Forecast AI <span class="badge bg-primary ms-2" style="font-size:0.6em;">BETA</span>
                    </h5>
                </div>
                <div class="modal-body">
                    <p class="lead-text">
                        Bienvenido a la primera plataforma de <strong>pron√≥stico s√≠smico experimental</strong> para el Per√∫ basada en Deep Learning.
                    </p>
                    
                    <div class="feature-list">
                        <div class="feature-item">
                            <span class="f-icon" aria-hidden="true">üß†</span>
                            <div>
                                <strong>Inteligencia Artificial</strong>
                                <p>Analiza patrones del historial s√≠smico con IA. (LSTM)</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <span class="f-icon" aria-hidden="true">üìÖ</span>
                            <div>
                                <strong>Pron√≥stico Semanal</strong>
                                <p>El sistema estima un nivel de riesgo relativo de sismos (M4.0+) para los pr√≥ximos 7 d√≠as.</p>
                            </div>
                        </div>
                    </div>

                    <div class="quick-steps mt-3" aria-label="Gu√≠a r√°pida de uso">
                        <div class="quick-steps-title">¬øC√≥mo funciona? (en 30 segundos)</div>
                        <ol class="quick-steps-list">
                            <li><strong>El modelo revisa</strong> patrones hist√≥ricos y calcula un <strong>nivel de riesgo relativo</strong> por zona.</li>
                            <li><strong>Colores y %</strong>: mientras m√°s alto, m√°s ‚Äúatenci√≥n‚Äù recomienda el modelo para los pr√≥ximos 7 d√≠as.</li>
                            <li><strong>Explora</strong>: toca una zona en el mapa o en la lista para ver detalles y abrirla en Google Maps.</li>
                        </ol>
                        <div class="quick-steps-footnote">
                            No es una alerta oficial ni garantiza que ocurra un sismo. Para emergencias, usa informaci√≥n del IGP/INDECI.
                        </div>
                    </div>


                    <div class="alert alert-warning d-flex align-items-start mt-3" role="alert">
                        <div style="font-size: 1.5rem; margin-right: 12px;" aria-hidden="true">‚ö†Ô∏è</div>
                        <div>
                            <strong>Aviso Importante:</strong>
                            <div style="font-size: 0.9rem; line-height: 1.4; margin-top: 4px;">
                                Este es un proyecto de <strong>investigaci√≥n acad√©mica</strong> (Tesis Universitaria - UPN). 
                                <strong>No reemplaza las alertas oficiales del IGP o INDECI.</strong> 
                                √ösalo con fines informativos y educativos.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-primary w-100 py-2 fw-bold" data-bs-dismiss="modal" id="btn-start">
                        ENTENDIDO, VER MAPA üåé
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal de Ayuda -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content dark-modal">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="helpLabel">‚ùì Ayuda: ¬øC√≥mo leer el mapa?</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar ayuda"></button>
                </div>
                <div class="modal-body">
                    <p class="lead-text" style="margin-bottom:12px;">
                        Este visor muestra d√≥nde el modelo detecta <strong>patrones inusuales</strong> y recomienda <strong>mayor atenci√≥n</strong> en los pr√≥ximos 7 d√≠as.
                        No es una alerta oficial.
                    </p>

                    <div class="accordion" id="helpAccordion">
                        <div class="accordion-item bg-transparent border-0">
                            <h2 class="accordion-header" id="h1">
                                <button class="accordion-button collapsed help-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#hc1" aria-expanded="false" aria-controls="hc1">
                                    1) ¬øQu√© significa el porcentaje (%)?
                                </button>
                            </h2>
                            <div id="hc1" class="accordion-collapse collapse" aria-labelledby="h1" data-bs-parent="#helpAccordion">
                                <div class="accordion-body help-acc-body">
                                    Es un <strong>score relativo</strong> (0‚Äì100) del modelo: sirve para comparar zonas entre s√≠.
                                    <br><strong>No</strong> significa ‚Äúprobabilidad exacta‚Äù ni garantiza que ocurrir√° un sismo.
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item bg-transparent border-0">
                            <h2 class="accordion-header" id="h2">
                                <button class="accordion-button collapsed help-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#hc2" aria-expanded="false" aria-controls="hc2">
                                    2) ¬øQu√© significan los colores?
                                </button>
                            </h2>
                            <div id="hc2" class="accordion-collapse collapse" aria-labelledby="h2" data-bs-parent="#helpAccordion">
                                <div class="accordion-body help-acc-body">
                                    Los colores agrupan el score en niveles para lectura r√°pida:
                                    <ul class="help-ul">
                                        <li><strong>Rojo:</strong> cr√≠tico (‚â•30%)</li>
                                        <li><strong>Rojo claro:</strong> muy alto (20‚Äì30%)</li>
                                        <li><strong>Naranja:</strong> alto (12‚Äì20%)</li>
                                        <li><strong>Amarillo:</strong> leve (5‚Äì12%)</li>
                                    </ul>
                                    Si una zona no aparece, su score est√° por debajo del m√≠nimo mostrado.
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item bg-transparent border-0">
                            <h2 class="accordion-header" id="h3">
                                <button class="accordion-button collapsed help-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#hc3" aria-expanded="false" aria-controls="hc3">
                                    3) ¬øC√≥mo usar la p√°gina?
                                </button>
                            </h2>
                            <div id="hc3" class="accordion-collapse collapse" aria-labelledby="h3" data-bs-parent="#helpAccordion">
                                <div class="accordion-body help-acc-body">
                                    <ol class="help-ol">
                                        <li>En la <strong>lista</strong>, toca una zona para que el mapa vaya a esa ubicaci√≥n.</li>
                                        <li>En el <strong>mapa</strong>, toca un punto para ver el popup con detalles.</li>
                                        <li>Usa <strong>buscar</strong> (lugar o coordenadas) y el <strong>filtro</strong> de nivel.</li>
                                        <li>Revisa la <strong>vigencia</strong> del pron√≥stico (rango de fechas) en la parte superior.</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item bg-transparent border-0">
                            <h2 class="accordion-header" id="h4">
                                <button class="accordion-button collapsed help-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#hc4" aria-expanded="false" aria-controls="hc4">
                                    4) Limitaciones y fuentes oficiales
                                </button>
                            </h2>
                            <div id="hc4" class="accordion-collapse collapse" aria-labelledby="h4" data-bs-parent="#helpAccordion">
                                <div class="accordion-body help-acc-body">
                                    Proyecto acad√©mico (Tesis UPN). √ösalo con fines informativos y educativos.
                                    Para alertas y recomendaciones oficiales, consulta siempre:
                                    <ul class="help-ul">
                                        <li><strong>IGP:</strong> registro de sismos</li>
                                        <li><strong>INDECI:</strong> recomendaciones y preparaci√≥n</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item bg-transparent border-0">
                            <h2 class="accordion-header" id="h5">
                                <button class="accordion-button collapsed help-acc-btn" type="button" data-bs-toggle="collapse" data-bs-target="#hc5" aria-expanded="false" aria-controls="hc5">
                                    Glosario r√°pido (sin tecnicismos)
                                </button>
                            </h2>
                            <div id="hc5" class="accordion-collapse collapse" aria-labelledby="h5" data-bs-parent="#helpAccordion">
                                <div class="accordion-body help-acc-body">
                                    <ul class="help-ul">
                                        <li><strong>Score:</strong> valor para comparar zonas (m√°s alto = m√°s atenci√≥n).</li>
                                        <li><strong>Ventana 7 d√≠as:</strong> el periodo futuro que eval√∫a el pron√≥stico.</li>
                                        <li><strong>Umbral:</strong> punto desde el cual el modelo considera ‚Äúactividad inusual‚Äù (para an√°lisis).</li>
                                        <li><strong>Detalles t√©cnicos:</strong> m√©tricas y datos para investigaci√≥n.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="help-footer-note">
                        Tip: Si est√°s en PC, puedes presionar la tecla <strong>H</strong> para abrir esta ayuda.
                    </div>
                </div>

                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-primary w-100 py-2 fw-bold" data-bs-dismiss="modal">
                        LISTO ‚úÖ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Vista mapa -->
    <div id="map-view-container" class="active">
        <div id="map" role="application" aria-label="Mapa interactivo de riesgo s√≠smico de Per√∫"></div>

        <!-- Widget √öltimo Sismo IGP -->
        <div class="last-quake-container" role="complementary" aria-label="√öltimo sismo registrado por el IGP">
            <div class="lq-header">
                <span class="pulse-icon" aria-hidden="true"></span> √öLTIMO SISMO IGP
            </div>
            <div class="lq-body" id="lq-content">
                <span class="lq-loading">Conectando con IGP...</span>
            </div>
            <div class="lq-footer">
                <a href="https://ultimosismo.igp.gob.pe/" target="_blank" class="igp-link" rel="noopener noreferrer" aria-label="Ver reporte oficial del IGP">
                    Ver reporte oficial ‚Üó
                </a>
            </div>
        </div>

        <!-- Indicador de carga general -->
        <div id="loading-overlay" class="loading-overlay" style="display:none;" aria-busy="false">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando datos...</span>
            </div>
            <p class="mt-2">Cargando pron√≥sticos...</p>
        </div>

        <!-- Toast de error -->
        <div id="error-toast" class="error-toast" style="display:none;" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="error-icon" aria-hidden="true">‚ö†Ô∏è</div>
            <div id="error-message"></div>
            <button class="error-close" onclick="closeErrorToast()" aria-label="Cerrar mensaje de error">√ó</button>
        </div>
    </div>

    <!-- Sidebar / Panel derecho -->
    <div class="sidebar-container" id="sidebar">
        
        <!-- Header -->
        <div class="sidebar-header">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="app-title">Quake Forecast AI</h1>
                <div class="d-flex align-items-center gap-2">
                    <button class="help-btn" id="btn-help" type="button"
                            aria-label="Abrir ayuda: ¬øC√≥mo funciona el mapa?"
                            title="Ayuda / ¬øC√≥mo leer el mapa?">
                        ‚ùì
                    </button>
                    <span class="badge-model" id="model-badge">Cargando...</span>
                </div>
            </div>
            <div class="status-indicator">
                <span class="status-dot" aria-hidden="true"></span> 
                <span>Sistema en l√≠nea</span>
            </div>
        </div>

        <!-- Metadatos de corrida -->
        <div class="run-meta-container">
            <div class="meta-row">
                <span class="meta-label">Actualizaci√≥n:</span>
                <span class="meta-value" id="generated-date">--</span>
            </div>
            <div class="meta-row">
                <span class="meta-label">Datos usados hasta:</span>
                <span class="meta-value" id="input-date">--</span>
            </div>
            <div class="meta-separator"></div>
            <div class="meta-row">
                <span class="meta-label">üìÖ VIGENCIA DEL PRON√ìSTICO:</span>
            </div>
            <div class="meta-row">
                <span class="meta-value highlight" id="validity-range" style="font-size: 1.1rem;">
                    Cargando...
                </span>
            </div>
        </div>

        <!-- Recuadro de recomendaci√≥n -->
        <div id="recommendation-box" class="alert-box" style="display:none;" role="alert" aria-live="polite">
            <div class="alert-icon" aria-hidden="true">‚ö†Ô∏è</div>
            <div id="recommendation-text"></div>
        </div>

        <!-- Tabs de modo (Ciudadan√≠a / Panel cient√≠fico) -->
        <div class="mode-tabs" role="tablist" aria-label="Seleccionar modo de visualizaci√≥n">
            <button class="mode-tab active" data-mode="citizen" id="tab-citizen" role="tab" aria-selected="true" aria-controls="citizen-panel">
                Visi√≥n ciudadana
            </button>
            <button class="mode-tab" data-mode="scientific" id="tab-scientific" role="tab" aria-selected="false" aria-controls="scientific-panel">
                Detalles t√©cnicos
            </button>
        </div>

        <!-- PANEL CIUDADANO -->
        <div id="citizen-panel" role="tabpanel" aria-labelledby="tab-citizen">
            <div class="list-header" id="topk-header">
                <span id="zones-count" aria-live="polite">Cargando zonas...</span>
                <button id="refresh-btn" class="refresh-btn" onclick="refreshData()" aria-label="Actualizar datos del pron√≥stico" title="Actualizar datos" aria-busy="false">
                    üîÑ
                </button>
            </div>

            <!-- Gu√≠a r√°pida (no t√©cnica) -->
            <div class="citizen-guide" id="citizen-guide" role="note" aria-label="Gu√≠a r√°pida para entender el mapa">
                <div class="cg-left">
                    <div class="cg-title">C√≥mo leer el mapa</div>
                    <div class="cg-text">
                        Los colores muestran un <strong>nivel de riesgo relativo</strong> del modelo para los pr√≥ximos 7 d√≠as.
                        Toca una zona (en el mapa o en la lista) para ver detalles.
                    </div>
                </div>
                <button class="cg-help-btn" type="button" id="btn-help-inline" aria-label="Abrir ayuda">
                    Abrir ayuda ‚ùì
                </button>
            </div>

            <!-- Barra de b√∫squeda y filtros -->
            <div class="search-filter-container">
                <label for="search-input" class="visually-hidden">Buscar zonas por ubicaci√≥n o coordenadas</label>
                <input 
                    type="text" 
                    id="search-input" 
                    class="search-input" 
                    placeholder="Buscar por lugar, coordenadas..."
                    aria-label="Buscar zonas por ubicaci√≥n o coordenadas"
                >
                <label for="filter-risk" class="visually-hidden">Filtrar por nivel de riesgo</label>
                <select id="filter-risk" class="filter-select" aria-label="Filtrar zonas por nivel de riesgo">
                    <option value="all">Todos los niveles</option>
                    <option value="critical">Cr√≠tico (‚â•30%)</option>
                    <option value="very-high">Muy alto (20-30%)</option>
                    <option value="high">Alto (12-20%)</option>
                    <option value="moderate">Leve (5-12%)</option>
                </select>
            </div>

            <div class="prediction-list" id="topk-list" role="region" aria-label="Lista de zonas con riesgo s√≠smico">
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3" style="color: var(--text-muted);">Analizando patrones s√≠smicos...</p>
                    <p style="font-size: 0.75rem; color: var(--text-muted); opacity: 0.7;">Esto puede tomar unos segundos</p>
                </div>
            </div>

            <!-- FOOTER COLAPSABLE -->
            <div class="sidebar-footer-compact">
                <button class="info-toggle-btn" 
                        id="info-toggle-btn" 
                        onclick="toggleFooterInfo()" 
                        aria-label="Mostrar informaci√≥n importante sobre el proyecto" 
                        aria-expanded="false"
                        aria-controls="info-content"
                        title="Informaci√≥n importante sobre el proyecto">
                    <span class="info-icon" aria-hidden="true">‚ÑπÔ∏è</span>
                    <span class="info-text">INFORMACI√ìN IMPORTANTE</span>
                    <span class="chevron" id="chevron-icon" aria-hidden="true">‚ñº</span>
                </button>
                <div class="info-content" id="info-content">
                    <div class="info-content-inner">
                        Este sistema forma parte de un proyecto de investigaci√≥n acad√©mica (Tesis Universitaria ‚Äì UPN).
                        <strong>Para alertas oficiales y recomendaciones de emergencia, siga √∫nicamente al INDECI y al IGP.</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL CIENT√çFICO -->
        <div id="scientific-panel" class="hidden" role="tabpanel" aria-labelledby="tab-scientific">
            <div class="sci-header">
                <h2 class="sci-title">Detalles t√©cnicos</h2>
                <p class="sci-subtitle">
                    Resumen t√©cnico del pron√≥stico actual.
                    Si buscas una explicaci√≥n simple, abre <strong>Ayuda ‚ùì</strong>.
                    (Modelo de investigaci√≥n, no operativo oficial).
                </p>
            </div>

            <div class="sci-grid">
                <div class="sci-item">
                    <span class="sci-label">Modelo activo:</span>
                    <span class="sci-value" id="sci-model">--</span>
                </div>
                <div class="sci-item">
                    <span class="sci-label">Total de zonas analizadas:</span>
                    <span class="sci-value" id="sci-total">--</span>
                </div>
                <div class="sci-item">
                    <span class="sci-label">Zonas visibles en mapa:</span>
                    <span class="sci-value" id="sci-visible">--</span>
                </div>
                <div class="sci-item">
                    <span class="sci-label">Prob. m√°xima detectada:</span>
                    <span class="sci-value" id="sci-maxprob">--</span>
                </div>
                <div class="sci-item">
                    <span class="sci-label">Prob. media (visibles):</span>
                    <span class="sci-value" id="sci-avgprob">--</span>
                </div>
                <div class="sci-item">
                    <span class="sci-label">Umbral de an√°lisis (calibraci√≥n):</span>
                    <span class="sci-value" id="sci-threshold">--</span>
                </div>
                <div class="sci-item">
                    <span class="sci-label">Zonas ‚â• umbral:</span>
                    <span class="sci-value" id="sci-above">--</span>
                </div>
                <div class="sci-item">
                    <span class="sci-label">Rango latitudinal:</span>
                    <span class="sci-value" id="sci-lat-range">--</span>
                </div>
                <div class="sci-item">
                    <span class="sci-label">Rango longitudinal:</span>
                    <span class="sci-value" id="sci-lon-range">--</span>
                </div>
            </div>

            <div class="sci-notes">
                <p>
                    ‚Ä¢ Los porcentajes son un <strong>indicador del modelo</strong> para comparar zonas (7 d√≠as, sismos ‚â• M4.0). No son ‚Äúprobabilidad exacta‚Äù.
                </p>
                <p>
                    ‚Ä¢ El ‚Äúumbral‚Äù es un valor de referencia obtenido en la calibraci√≥n del modelo (pruebas hist√≥ricas).
                </p>
                <p>
                    ‚Ä¢ Este panel es para investigaci√≥n: revisar m√©tricas, cobertura espacial y comportamiento del modelo.
                </p>
            </div>
            
            <!-- Footer tambi√©n en panel cient√≠fico -->
            <div class="sci-footer-info">
                <strong>‚ÑπÔ∏è Proyecto acad√©mico (Tesis Universitaria - UPN)</strong> - Para alertas oficiales consulta con INDECI / IGP
            </div>
        </div>
    </div>

    <!-- Navegaci√≥n m√≥vil (mapa / panel) -->
    <nav class="mobile-nav" aria-label="Navegaci√≥n principal m√≥vil">
        <button class="nav-btn" onclick="switchTab('list')" id="btn-list" aria-label="Ver lista de zonas" aria-current="false">
            <span class="nav-icon" aria-hidden="true">üìã</span> 
            <span>Lista</span>
        </button>
        <button class="nav-btn active" onclick="switchTab('map')" id="btn-map" aria-label="Ver mapa" aria-current="true">
            <span class="nav-icon" aria-hidden="true">üåé</span> 
            <span>Mapa</span>
        </button>
        <button class="nav-btn" onclick="openHelp('mobile_nav')" id="btn-help-mobile" aria-label="Abrir ayuda" aria-current="false">
            <span class="nav-icon" aria-hidden="true">‚ùì</span> 
            <span>Ayuda</span>
        </button>
    </nav>

    <!-- JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
</body>
</html>